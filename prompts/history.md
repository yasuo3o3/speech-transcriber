# Speech Transcriber - Development History

## 2025-01-25 18:30 JST - README強化・Notionインテグレーション権限付与の明記

### 送信プロンプト全文
修正依頼（README強化・Notionインテグレーションの権限付与を明記）：

背景：既存インテグレーションを流用した際、保存先ページに権限が付いておらず「Could not find page with ID …」が発生した。READMEに正しい手順を追記して、同種のトラブルを防ぎたい。

対応：README.md に下記「README追記用テキスト」を追加してください（文言微調整可、意味は等価に）。既存ファイルは上書きで構いません。処理は止まらないように。

あわせて prompts/history.md に、この修正依頼のログを追記してください（日時JST・件名・送信プロンプト全文・出力要約・次アクションを追記。追記であって上書き不可）。

README追記用テキスト（そのまま入れてOK）：

Notion Integration の設定
A. 新規にインテグレーションを作る場合

https://www.notion.so/my-integrations
 で New integration を作成し、NOTION_TOKEN を取得します。

Capabilities（権限）は「Read content」「Insert content」「Update content」を有効にしてください。

保存先となる親ページを開き、右上の「共有」または「…」メニューから Integration を接続（Add connections / Invite） します。

親ページURL末尾の32桁IDを .env に設定します（ハイフン有無どちらでも可）：
NOTION_PARENT_PAGE_ID=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

.env 例：
NOTION_TOKEN=secret_xxxxxxxxxxxxxxxxx
NOTION_PARENT_PAGE_ID=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

B. 既存インテグレーションを「使い回す」場合（ハマりどころ）

https://www.notion.so/profile/integrations/
 を開き、対象インテグレーションを選択します。

「アクセス」タブ → 右上の アクセス権限を編集 をクリックします。

検索欄で保存先の親ページを指定し、アクセスを更新（追加） します。

これでその親ページ配下に API で子ページを作成できるようになります。

.env は既存の NOTION_TOKEN をそのまま使い、NOTION_PARENT_PAGE_ID に親ページID（URL末尾32桁）を設定します。

よくあるエラー

Could not find page with ID: ...
→ ほぼ権限不足です。上記 A-2 または B-3 の「ページにインテグレーションを接続（アクセス付与）」が未実施です。

別ワークスペースのトークンを使っている
→ 親ページと同じワークスペースのインテグレーションを使用してください。

受け入れ基準：

README.md に新規作成ケース(A)と既存流用ケース(B)の両方が明記され、Could not find page with ID の再発を防げること。

prompts/history.md に本依頼のログが追記されていること（上書きではなく追記）。

### 出力概要
- README.md の Notion Integration セクションを大幅強化
- 新規作成ケース(A)と既存流用ケース(B)の詳細手順を追加
- 「Could not find page with ID」エラーの原因と対処法を明記
- prompts/history.md を新規作成し、開発履歴の記録を開始

### 主要ファイル
- README.md（73-110行目に詳細なNotion設定手順を追加）
- prompts/history.md（新規作成、本ログを記録）

### 注意点
- 既存インテグレーション流用時のアクセス権限追加手順が重要
- ワークスペース間違いによるエラーケースも言及

### 次アクション
- .env ファイルにNotion設定情報を入力
- 新規または既存インテグレーションの適切な権限設定を実施
- python main.py で動作確認実行

## 2025-01-25 19:15 JST - IMEとDiscordレイアウトの調整

### 送信プロンプト全文
修正依頼（IMEとDiscordレイアウトの調整）：

【背景】

保存確認プロンプトの y/n 入力で、日本語IMEが有効のまま 全角「ｙ／ｎ」 を入力→Enter→さらにEnter…の流れで、意図せず No 扱いで破棄 される事故が発生。

Discord への投稿で タイトル行とサマリー行の間に空行が1行 入ってしまい、詰めたい。

【対応方針】

保存確認の y/n 入力を ロバスト化。全角/半角や大小文字を正規化して判定。未判定は再入力を促す。

Discord 投稿の 余計な空行をなくす（タイトルの直下にサマリーを1行で続ける）。

【具体指示】

A. 保存確認の入力処理を改善

入力文字列に対して Unicode 正規化（NFKC）→ strip() → lower() を適用し、以下を同一視して判定する：

Yes 系：y, yes, ｙ, Ｙ, はい

No 系： n, no, ｎ, Ｎ, いいえ

上記どちらにも当てはまらない場合は 決してデフォルトで No にしない。
→ 「入力が認識できません。y/yes/はい または n/no/いいえ を入力してください。」と再度プロンプト。

事故防止のため、No を選んだときだけ二段階確認を入れてください：

例：「本当にこの録音を破棄しますか？ (y/n)」

ここでも同じ正規化ロジックを適用し、y/はい のときだけ破棄。n/いいえ は保存フローへ戻す。

既存の処理フロー（Enterで停止→保存 or 破棄→保存時はタイトル/概要入力→Discord/Notion送信）は維持。

B. Discord 投稿の空行を除去

Webhook の content を タイトル + 改行 + サマリー のみで構築し、余分な改行（先頭・末尾の \n、二重 \n\n）を入れない。

明示仕様：

サマリーあり："{title}\n{summary}"

サマリー空："{title}"（末尾改行なし）

送信前に title / summary は strip() で前後空白・改行を除去。

もし埋め込み（embeds）を使っている場合も、タイトル→説明の間に空行が入らないように構築。不要なら content 方式でOK。

既存の Discord 投稿の他仕様（リトライ、allowed_mentions など）は現状踏襲。

【受け入れ基準】

日本語IMEがオンで 全角「ｙ」「ｎ」 を入力しても、正しく Yes/No として認識される。

未判定文字（例：「ー」「yです」など）を入れても 勝手に No に落ちず、再入力を促す。

No 選択時のみ 二段階確認が出て、y/はい 確定で破棄、n/いいえ で保存フローに戻る。

Discordの投稿は タイトル行の直下にサマリー行が続き、空行は入らない。サマリー未入力時はタイトルのみが1行で投稿される。

既存の README / ドキュメントに、この入力仕様（全角対応＆No時の二段階確認）と Discord の改行ルールを追記。

prompts/history.md に本修正依頼のログを 追記（上書き禁止）。

備考：

文字正規化には Python の unicodedata.normalize("NFKC", s) を利用してください。実装は任意ですが、NFKC→strip→lower の順が望ましい。

既存ファイルは 上書きでOK。処理がダイアログで止まらないように進めてください。

### 出力概要
- main.py に Unicode 正規化による入力処理を実装
- 全角・半角文字の自動認識機能を追加（y/ｙ/yes/はい など）
- No選択時の二段階確認機能を実装
- discord_client.py の投稿形式を改善（余分な空行を除去）
- README.md に新しい入力仕様とDiscord投稿形式を明記

### 主要ファイル
- main.py（93-117行目に入力正規化機能、190-200行目に二段階確認フロー）
- discord_client.py（19-27行目にクリーンな投稿形式）
- README.md（125-144行目に詳細な操作手順と投稿形式）

### 注意点
- unicodedata.normalize("NFKC") による全角・半角統一
- 未判定入力時はデフォルトでNoにしない安全設計
- 二段階確認による誤操作防止

### 次アクション
- 日本語IME有効状態での動作確認
- 全角文字入力テスト（ｙ、ｎ、はい、いいえ）
- Discord投稿の空行確認とテスト

## 2025-01-25 19:45 JST - ユーザープロンプトの日本語統一＋選択ヒント表示

### 送信プロンプト全文
修正依頼（ユーザープロンプトの日本語統一＋選択ヒント表示＋全角対応は現状維持）：

【背景】

保存確認や再確認、タイトル/概要入力など「ユーザーが入力するプロンプト」の言語が混在している。

Yes/No の意味が直感的に分かるよう、(y=保存 / n=破棄) などのヒントを併記したい。

すでに導入済みの全角対応（NFKC 正規化）＆ No 時のみ二段階確認は維持。

【対応方針】

重要プロンプトは日本語に統一し、メッセージはファイル冒頭に定数で集約。

定数には英語版の参考文言をコメントで併記（EN: ...）。実装は日本語をデフォルトとする。

実行ログ（Saving..., Successfully ...）などは英語のままでよい（変更不要）。

【具体指示】

main.py の先頭付近に下記定数を定義し、既存の入力プロンプト表示箇所をすべて置き換える。

すでにある NFKC→strip→lower の正規化、ならびに No 選択時の二段階確認ロジックはそのまま適用すること。

定数（そのまま使用可）：
MSG_SAVE_CONFIRM = "この録音を保存しますか？ (y=保存 / n=破棄): " # EN: "Do you want to save this recording? (y=save / n=discard): "
MSG_DISCARD_CONFIRM = "本当にこの録音を破棄しますか？ (y=破棄 / n=保存に戻る): " # EN: "Are you sure you want to discard this recording? (y=discard / n=go back to save): "
MSG_ENTER_TITLE = "タイトルを入力してください: " # EN: "Enter title: "
MSG_ENTER_SUMMARY = "概要を入力してください（空でも可）: " # EN: "Enter summary (optional): "
MSG_INPUT_INVALID = "入力が認識できません。y/yes/はい または n/no/いいえ を入力してください。"

上記の提示どおり、保存確認・破棄確認・タイトル/概要入力・無効入力時のメッセージをこの定数経由で表示する。

Yes/No 判定は既存どおり NFKC 正規化＋大小無視＋日本語（はい/いいえ）対応で行う。

他の挙動（Enterで停止、保存フロー、Discord/Notion送信、ログ出力）は変更しない。

【README 追記】

「プロンプトの言語を変更したい場合は main.py 冒頭の MSG_* 定数を書き換えるだけでよい。英語例はコメント（EN: ...）を参照」と短く追記。

【history.md】

本修正依頼を追記（日時JST／件名／送信プロンプト全文／出力要約／次アクション）。追記であって上書き不可。

【受け入れ基準】

重要プロンプトが日本語で統一され、(y=保存 / n=破棄) などのヒントが併記されている。

全角のｙ/ｎ、はい/いいえ、YES/NO などが正しく解釈され、未判定入力は MSG_INPUT_INVALID を表示して再入力を促す。

No を選んだ場合のみ二段階確認（MSG_DISCARD_CONFIRM）が出る。n を選べば保存フローに戻る。

実行ログ系メッセージは従来どおり英語のまま。

README と history.md が更新されている。

### 出力概要
- main.py 冒頭に日本語プロンプト定数（MSG_*）を追加
- 全ユーザー入力プロンプトを日本語に統一
- 選択ヒント (y=保存 / n=破棄) を各確認メッセージに追加
- 概要入力を「空でも可」に変更し、必須チェックを削除
- README.md にプロンプト言語カスタマイズ方法を追記

### 主要ファイル
- main.py（21-25行目にメッセージ定数、120/124/198/236/242行目でプロンプト使用）
- README.md（195-197行目にカスタマイズ手順を追加）
- prompts/history.md（本ログエントリを追記）

### 注意点
- 既存のUnicode正規化と二段階確認ロジックは完全維持
- 実行ログ系メッセージは英語のまま（仕様通り）
- 概要入力を任意入力に変更（空でも処理続行）

### 次アクション
- 日本語プロンプトでの動作確認
- 選択ヒント表示の視認性テスト
- 概要空入力時の正常動作確認

## 2025-01-25 20:00 JST - main.pyの入力メッセージ更新に伴うREADME整備

### 送信プロンプト全文
修正依頼（main.pyの入力メッセージ更新に伴うREADME整備。内部互換は維持）：

【前提変更】

main.py の無効入力メッセージを下記に更新しました（この定数はそのまま使用を維持してください）。
MSG_INPUT_INVALID = "入力が認識できません。[y]または[n]を入力してください。"

【要望】

README.md を更新してください。ユーザー向けには 入力は y / n のみ と明記し、全角ｙ／ｎも可と書いてください。

例文（意図が伝われば文面は調整可）：

「保存可否のプロンプトには y または n で回答してください（全角ｙ／ｎも可）。その他の入力は無効として再入力を促します。」

「No を選んだ場合のみ破棄の再確認が表示されます。」

注意：実装側では互換のため「はい / いいえ」も受理するロジック（NFKC→strip→lower 後の判定）を残したままにしてください。

ただし README には y/nのみを案内し、「はい/いいえ」対応は記載しないでください（ドキュメント非公開仕様）。

既存の NFKC 正規化・No時のみ二段階確認ロジックはそのまま維持。

プロンプト文言（日本語）の定数化とコメント（EN: …）の方針は既存どおりでOK。必要があれば MSG_INPUT_INVALID の近くに統一感のある位置へ整理して構いません。

prompts/history.md に本依頼のログを追記してください（日時JST・件名・送信プロンプト全文・出力要約・次アクション）。追記であって上書き不可。

【受け入れ基準】

README に「入力は y / n（全角可）、その他は無効」「No選択時のみ再確認」の説明が追記されている。

実装では引き続き「はい / いいえ」も受理するが、README には明記しない。

main.py の MSG_INPUT_INVALID は指定どおりで動作し、実行時のユーザー体験が y/n に一本化されている。

history.md が追記されている。

### 出力概要
- README.md の操作手順を y/n 入力仕様に更新
- ユーザー向けドキュメントで入力方式を明確化（y または n、全角可）
- 「No 選択時のみ再確認」の動作説明を追加
- 内部実装の「はい/いいえ」対応は非公開仕様として維持

### 主要ファイル
- README.md（130-134行目の操作手順を簡潔化）
- prompts/history.md（本ログエントリを追記）

### 注意点
- 実装では「はい/いいえ」も引き続き受理（後方互換性維持）
- README では y/n のみ案内（ユーザー体験の統一）
- MSG_INPUT_INVALID の更新内容を反映

### 次アクション
- y/n 入力での動作確認
- 全角 ｙ/ｎ 入力テスト
- 「はい/いいえ」の非公開仕様動作確認

## 2025-01-25 20:15 JST - READMEにWindowsワンボタン実行手順を追記

### 送信プロンプト全文
修正依頼（READMEにWindowsワンボタン実行手順を追記）：

【背景】
Windows環境で Speech Transcriber を簡単に起動する方法を利用者に分かりやすく案内したい。
そこで、main.py を直接実行する代わりに、バッチファイルでワンボタン起動できる手順を README.md に追記してほしい。

【追記内容】
README.md に以下のセクションを追加してください（文言調整可だが内容は等価にすること）：

Windowsでワンボタン実行する方法

プロジェクトのルートディレクトリ（main.py がある場所）に run_transcriber.bat というファイルを作成し、以下の内容を貼り付けて保存します：

@echo off
REM ===== Speech Transcriber 実行バッチ =====
cd /d %~dp0
python main.py
pause


cd /d %~dp0 : このバッチファイルが置いてある場所に移動します

python main.py : プログラムを実行します

pause : 実行後にウィンドウが自動で閉じないようにします

run_transcriber.bat を ダブルクリックすることで、Speech Transcriber が起動します。

より便利にするには、run_transcriber.bat の ショートカットを作成し、デスクトップなどに配置してください。

プロパティからアイコンを変更することで分かりやすくできます。

【READMEで不要なもの】

Android の説明はまだ追記しない（別途後で行う予定）。

Python環境のセットアップ手順など既存の記載はそのまま維持。

【history.md】

この修正依頼のログを追記してください（日時JST／件名／送信プロンプト全文／出力要約／次アクション）。追記であって上書き不可。

【コミット文】

この変更に対応する git commit メッセージを日本語で提案してください。

【受け入れ基準】

README.md に Windows 向けのワンボタン実行手順が追加されている。

内容を読んだ利用者がバッチファイルを作成し、ダブルクリックで起動できる。

history.md に本依頼の記録が追記されている。

日本語のコミットメッセージが提示されている。

### 出力概要
- README.md に「Windowsでワンボタン実行する方法」セクションを追加
- run_transcriber.bat の作成手順と内容を詳細に説明
- 各バッチコマンドの役割を分かりやすく解説
- ショートカット作成による利便性向上の提案を追記

### 主要ファイル
- README.md（120-141行目にWindowsバッチ実行手順を追加）
- prompts/history.md（本ログエントリを追記）

### 注意点
- バッチファイルの内容を完全に記載し、コピー&ペーストで使用可能
- 各コマンドの説明により初心者でも理解しやすい構成
- ショートカット作成とアイコン変更の提案で使いやすさを向上

### 次アクション
- run_transcriber.bat ファイルの作成テスト
- ダブルクリック起動の動作確認
- ショートカット作成とアイコン変更の検証

## 2025-01-25 20:30 JST - Notion 送信の長文対応：チャンク分割・バッチ投入・ページ分割の実装

### 送信プロンプト全文
修正依頼（Notion 送信の長文対応：チャンク分割・バッチ投入・ページ分割の実装）

【背景】

文字起こし本文が長文になるケースで、Notion API の制限（1ブロックの文字数、1リクエストあたりの children 上限、ページ全体の実質上限など）に安全に対応したい。

既存実装は通常サイズでは問題ないが、極端に長い本文でも確実に保存できるようにしたい。

【要件】

段落→ブロック分割

「句点（。）」区切りで既に改行整形済みの本文テキストを、段落ごとに paragraph ブロックへ変換。

1リッチテキスト当たりの文字数上限を考慮し、長すぎる段落は安全側で 1800 文字を上限目安に分割（NFKCは不要、単純文字数分割で可。文の途中でも可、末尾に「…」などは不要）。

バッチ投入

Notion API の children 追加は1リクエストあたり 100 ブロック上限があるため、50 ブロック/回程度でバッチ投入。

既存の**リトライ（最大3回）**は維持。429/5xx は指数バックオフで再試行。

ページ分割（ソフト上限）

1ページに追加する本文の総文字数が 80,000 文字を超えそうなら、自動で続きの子ページを作って分割保存する（タイトルは「{元タイトル}（続き1）」「（続き2）」の連番）。

段落の途中では分割しない。ブロック境界で切り替える。

本文の前置きレイアウトは現状維持

ページ構成：「日時・タイトル → 区切り線 → 概要 → 区切り線 → 本文」のまま。

今回は本文ブロックの投入方法のみを強化する。概要やタイトルの扱いは変更しない。

副作用防止 / 冪等性

途中失敗で再実行した際に二重挿入にならないよう、1回の保存処理内で完了した子ページIDや最後に投入したブロック数を手元で管理し、失敗リトライは未投入の残りから再開する（メモリ内のセッション管理で可。外部ストアは不要）。

完了後に「保存した総ブロック数」「作成した子ページ数」をログ出力。

コード配置

notion_api.py（旧 notion_client.py）に以下の関数を追加・更新：

chunk_paragraphs_for_notion(text: str, max_len: int = 1800) -> list[str]

make_paragraph_block(text: str) -> dict

append_children_batched(blocks: list[dict], parent_id: str, batch_size: int = 50)

create_or_split_page_for_long_content(title: str, header_blocks: list[dict], body_blocks: list[dict], parent_page_id: str, page_soft_limit_chars: int = 80000)

既存の送信フローから上記関数を呼ぶように差し替え（main.py 側の呼び出しは最小変更）。

README 追記（概要のみ）

「長文でも自動的に段落分割・バッチ送信・必要に応じてページ分割されます。設定値（段落分割 1800 文字、1リクエスト 50 ブロック、1ページ 80,000 文字のソフト上限）は notion_api.py の定数で調整可能。」の説明を短く追記。

history.md

本依頼のログを追記（日時JST／件名／送信プロンプト全文／出力要約／次アクション）。追記であって上書き不可。

【受け入れ基準】

10万文字級の長文を与えても、Notion への保存がエラーなく完走する（ページが複数に分割されても可）。

1段落が 1800 文字を超える場合でも、自動で複数 paragraph ブロックに割れて保存される。

ブロックは 50 件ずつのバッチ投入で送られ、429/5xx が発生しても既存のリトライで回復する。

途中失敗からの再実行でも、二重挿入にならず未投入分から続きが保存される。

README と history.md が更新されている。

【コミット文】

この変更に対応する git commit メッセージを日本語で提案してください。

### 出力概要
- notion_api.py に長文処理用の新機能を実装
- 段落チャンク分割（1800文字上限）でNotion API制限に対応
- 50ブロック単位のバッチ投入でレート制限を回避
- 80,000文字超過時の自動ページ分割機能
- 既存のリトライ機能を維持しつつ堅牢性を向上
- README.md に長文対応機能の説明を追加

### 主要ファイル
- notion_api.py（11-13行目に定数追加、27-252行目に長文処理機能実装）
- README.md（216-218行目に長文対応説明を追加）
- prompts/history.md（本ログエントリを追記）

### 注意点
- 既存の create_page メソッドを完全リニューアル
- バッチ処理とページ分割でNotionAPI制限を安全に回避
- メモリ内セッション管理による冪等性確保
- 詳細なログ出力で処理状況を可視化

### 次アクション
- 10万文字級の長文での動作テスト
- バッチ投入と自動ページ分割の確認
- レート制限時のリトライ動作検証